<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      #canvas-container {
        width: 100%;
        text-align:center;
      }

      canvas {
        height: 90vh;
        display: inline;
      }
    </style>
  </head>
  <body>
    <div id='canvas-container'>
      <canvas id='gameCanvas'></canvas>
    </div>
    <script>
      
      // Draw a rectangle in canvas so we can see it
      var player = function(){
        this.shipType = ships['bead'];
        this.gunType = guns['peaShooter'];
        this.position = { x: 500, y: 900 };
        this.speedX = 0;
        this.speedY = 0;
        this.heat = 0;
        this.hp = this.shipType.hp;
        this.maxHeat = this.shipType.maxHeat;
        this.newPosX = function(){
          return this.speedX * game.canvas.width * this.shipType.maxVelocity
        }
        this.newPosY = function(){
          return this.speedY * game.canvas.height * this.shipType.maxVelocity
        }
        this.update = function(){
          this.position.x += this.newPosX();
          this.position.y += this.newPosY();
        }
      }

      var ships = {
        bead: {
          shipBody: {
            hull: { 
                    position: { x: 29, y: 1 },
                    size: { width: 23, height: 62 },
                    color:  '#2bb59c',
                    mass: 1
                  },
            wings: {
                    position: { x: 8, y: 21 }, 
                    size: { width: 64, height: 15 },
                    color:  '#2bb59c',
                    mass: 1
                  },
            specialLeft: { 
                    position: { x: 1, y: 25 },
                    size: { width: 15, height: 25 },
                    color:  '#2bb59c',
                    mass: 1
            },
            specialRight: { 
                    position: { x: 63, y: 25 },
                    size: { width: 15, height: 25 },
                    color:  '#2bb59c',
                    mass: 1
            },
            cockpit: { 
                    position: { x: 35, y: 10 },
                    size: { width: 11, height: 21 },
                    color:  '#00ffff',
                    mass: 1
                  }
          },
          size: { width: 77, height: 62 },
          maxVelocity: 0.0032,
          hp: 4,
          maxHeat: 100
        }
      }

      var guns = {
        peaShooter: {
          baseMagCapacity: 10,
          currentMagCapacity: 10,
          currentMagRemaining: 10,
          magLevelIncrement: 5,
          heatPerShot: 7,
          rateOfFire: 1.25,
          bulletWidth: .01,
          bulletVelocity: .001
        }
      }
      
      var game = {
        canvas: document.getElementById('gameCanvas'),
        update: function(){
          game.clear();
          gamePlayer.speedX = 0;
          gamePlayer.speedY = 0;
          if (game.keys && game.keys[37]) {gamePlayer.speedX = -1; }
          if (game.keys && game.keys[39]) {gamePlayer.speedX = 1; }
          if (game.keys && game.keys[38]) {gamePlayer.speedY = -1; }
          if (game.keys && game.keys[40]) {gamePlayer.speedY = 1; }
          if (gamePlayer.speedX != 0 || gamePlayer.speedY != 0){
            gamePlayer.update();
          }
          game.sendData();
          game.draw();
          setTimeout(game.update, 10);
        },
        sendData: function(){
          ws.send(`[${JSON.stringify({date: Date(), position: gamePlayer.position})}]`);
        },
        draw: function(){
          game.drawBackground();
          game.drawPlayer();
        },
        drawPlayer: function(){
          Object.values(gamePlayer.shipType.shipBody).forEach((piece) => {
            this.ctx.fillStyle = piece.color
            this.ctx.fillRect(gamePlayer.position.x + piece.position.x, gamePlayer.position.y + piece.position.y, piece.size.width, piece.size.height);
          });
        },
        drawBackground: function(){
          this.ctx.beginPath();
          this.ctx.rect(0, 0, 1000, 1000);
          this.ctx.fillStyle = "#8e60b6";
          this.ctx.fill();
        },
        clear : function() {
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        },
        startGame: function(){
        // Set canvas size and get context
        this.canvas.width = 1000;
        this.canvas.height = 1000;
        gamePlayer = new player();
        this.ctx = this.canvas.getContext('2d');
        window.addEventListener('keydown', function (e) {
          game.keys = (game.keys || []);
          game.keys[e.keyCode] = true;
        })
        window.addEventListener('keyup', function (e) {
          game.keys[e.keyCode] = false;
        })
        game.update();
      }

      }
      // Uncomment the below line to test the game without networking
      // game.startGame();

      // Create a websocket for sending data to the server
      const ws = new WebSocket('ws://localhost:8080','json');

      // Send a message to the server after successfully connecting to the server
      ws.onopen = function open() {
        ws.send('something');
        game.startGame();
        // Uncomment the below line and comment out the above line to only test networking
        // sendData();
      };

      // Upon receiving a message from the server, do this
      ws.onmessage = function incoming(data) {
        console.log(data);
      };

      // Loop to repeatedly send updated data
      function sendData(){
        ws.send('something');
        setTimeout(function(){ sendData() }, 10000);
      }
      
    </script>
  </body>
</html>